<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eagle Scout</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0d1117;
      color: #e6edf3;
      min-height: 100vh;
      padding: 24px;
    }

    header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 28px;
    }

    header h1 {
      font-size: 22px;
      font-weight: 600;
      color: #f0f6fc;
    }

    header .badge {
      font-size: 11px;
      background: #1f6feb;
      color: #fff;
      padding: 2px 8px;
      border-radius: 12px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      align-items: center;
    }

    select, input[type="text"] {
      background: #161b22;
      border: 1px solid #30363d;
      color: #e6edf3;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      min-width: 280px;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #1f6feb;
    }

    button {
      background: #1f6feb;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    button:hover { background: #388bfd; }
    button:disabled { background: #30363d; cursor: default; }

    .btn-secondary {
      background: #21262d;
      border: 1px solid #30363d;
    }
    .btn-secondary:hover { background: #30363d; }

    .tabs {
      display: flex;
      gap: 2px;
      border-bottom: 1px solid #30363d;
      margin-bottom: 20px;
    }

    .tab {
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 6px 6px 0 0;
      color: #8b949e;
      border: 1px solid transparent;
      border-bottom: none;
    }

    .tab.active {
      color: #f0f6fc;
      background: #161b22;
      border-color: #30363d;
      margin-bottom: -1px;
    }

    .tab:hover:not(.active) { color: #e6edf3; }

    .panel { display: none; }
    .panel.active { display: block; }

    .output-box {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 16px;
      font-family: "SF Mono", "Fira Code", monospace;
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 200px;
      max-height: 600px;
      overflow-y: auto;
      color: #c9d1d9;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }

    .image-card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 14px 16px;
      cursor: pointer;
      transition: border-color 0.15s;
    }

    .image-card:hover { border-color: #1f6feb; }
    .image-card.selected { border-color: #1f6feb; background: #0d1926; }

    .image-card .repo {
      font-weight: 600;
      font-size: 13px;
      color: #58a6ff;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .image-card .meta {
      font-size: 11px;
      color: #8b949e;
      display: flex;
      gap: 12px;
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #30363d;
      border-top-color: #1f6feb;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .status {
      font-size: 12px;
      color: #8b949e;
      margin-bottom: 12px;
      min-height: 18px;
    }

    .filter-row {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
      align-items: center;
    }

    label { font-size: 12px; color: #8b949e; }

    .severity-toggle {
      display: flex;
      gap: 6px;
    }

    .sev-btn {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 12px;
      background: #21262d;
      border: 1px solid #30363d;
      color: #8b949e;
    }

    .sev-btn.active { color: #fff; border-color: transparent; }
    .sev-btn.critical.active { background: #da3633; }
    .sev-btn.high.active { background: #d29922; }
    .sev-btn.medium.active { background: #e3b341; color: #0d1117; }
    .sev-btn.low.active { background: #388bfd; }
  </style>
</head>
<body>

<header>
  <h1>Eagle Scout</h1>
  <span class="badge">Docker Scout</span>
</header>

<div class="toolbar">
  <select id="imageSelect"><option value="">Loading images...</option></select>
  <button id="refreshImages" class="btn-secondary" onclick="loadImages()">Refresh</button>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('quickview')">Quickview</div>
  <div class="tab" onclick="switchTab('cves')">CVEs</div>
  <div class="tab" onclick="switchTab('recommendations')">Recommendations</div>
</div>

<!-- Quickview -->
<div id="tab-quickview" class="panel active">
  <div class="status" id="qv-status"></div>
  <div class="output-box" id="qv-output">Select an image and click Scan.</div>
  <br/>
  <button onclick="runQuickview()" id="qv-btn">Scan</button>
</div>

<!-- CVEs -->
<div id="tab-cves" class="panel">
  <div class="filter-row">
    <label>Filter:</label>
    <div class="severity-toggle">
      <button class="sev-btn critical" onclick="toggleSev(this,'critical')">Critical</button>
      <button class="sev-btn high" onclick="toggleSev(this,'high')">High</button>
      <button class="sev-btn medium" onclick="toggleSev(this,'medium')">Medium</button>
      <button class="sev-btn low" onclick="toggleSev(this,'low')">Low</button>
    </div>
    <label style="margin-left:12px">
      <input type="checkbox" id="onlyFixed" /> Fixable only
    </label>
  </div>
  <div class="status" id="cve-status"></div>
  <div class="output-box" id="cve-output">Select an image and click Scan.</div>
  <br/>
  <button onclick="runCVEs()" id="cve-btn">Scan</button>
</div>

<!-- Recommendations -->
<div id="tab-recommendations" class="panel">
  <div class="status" id="rec-status"></div>
  <div class="output-box" id="rec-output">Select an image and click Scan.</div>
  <br/>
  <button onclick="runRecommendations()" id="rec-btn">Scan</button>
</div>

<script>
  // Docker Desktop extension SDK communication
  const ddClient = window.ddClient;
  let activeSeverity = null;

  function api(path) {
    if (ddClient) {
      return ddClient.extension.vm.service.get(path);
    }
    // Dev fallback: direct HTTP (won't work in production extension)
    return fetch('http://localhost:8080' + path).then(r => r.json());
  }

  async function loadImages() {
    const sel = document.getElementById('imageSelect');
    sel.innerHTML = '<option value="">Loading...</option>';
    try {
      const images = await api('/images');
      sel.innerHTML = '<option value="">-- select an image --</option>';
      (images || []).forEach(img => {
        if (img.repository === '<none>') return;
        const opt = document.createElement('option');
        opt.value = `${img.repository}:${img.tag}`;
        opt.textContent = `${img.repository}:${img.tag}  (${img.size})`;
        sel.appendChild(opt);
      });
    } catch (e) {
      sel.innerHTML = '<option value="">Error loading images</option>';
    }
  }

  function selectedImage() {
    return document.getElementById('imageSelect').value;
  }

  function setStatus(id, msg, loading) {
    const el = document.getElementById(id);
    el.innerHTML = loading ? `<span class="spinner"></span>${msg}` : msg;
  }

  async function runQuickview() {
    const image = selectedImage();
    if (!image) return alert('Select an image first.');
    setStatus('qv-status', `Scanning ${image}...`, true);
    document.getElementById('qv-btn').disabled = true;
    try {
      const res = await api(`/quickview?image=${encodeURIComponent(image)}`);
      document.getElementById('qv-output').textContent = res.output || res.error;
      setStatus('qv-status', `Scanned: ${image}`);
    } catch (e) {
      document.getElementById('qv-output').textContent = String(e);
      setStatus('qv-status', 'Error');
    }
    document.getElementById('qv-btn').disabled = false;
  }

  async function runCVEs() {
    const image = selectedImage();
    if (!image) return alert('Select an image first.');
    let path = `/cves?image=${encodeURIComponent(image)}`;
    if (document.getElementById('onlyFixed').checked) path += '&only_fixed=true';
    if (activeSeverity) path += `&severity=${activeSeverity}`;
    setStatus('cve-status', `Scanning ${image}...`, true);
    document.getElementById('cve-btn').disabled = true;
    try {
      const res = await api(path);
      document.getElementById('cve-output').textContent = res.output || res.error;
      setStatus('cve-status', `Scanned: ${image}`);
    } catch (e) {
      document.getElementById('cve-output').textContent = String(e);
      setStatus('cve-status', 'Error');
    }
    document.getElementById('cve-btn').disabled = false;
  }

  async function runRecommendations() {
    const image = selectedImage();
    if (!image) return alert('Select an image first.');
    setStatus('rec-status', `Fetching recommendations for ${image}...`, true);
    document.getElementById('rec-btn').disabled = true;
    try {
      const res = await api(`/recommendations?image=${encodeURIComponent(image)}`);
      document.getElementById('rec-output').textContent = res.output || res.error;
      setStatus('rec-status', `Done: ${image}`);
    } catch (e) {
      document.getElementById('rec-output').textContent = String(e);
      setStatus('rec-status', 'Error');
    }
    document.getElementById('rec-btn').disabled = false;
  }

  function switchTab(name) {
    document.querySelectorAll('.tab').forEach((t, i) => {
      t.classList.toggle('active', t.textContent.toLowerCase().replace(/\s/g,'') === name);
    });
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
  }

  function toggleSev(btn, sev) {
    if (activeSeverity === sev) {
      activeSeverity = null;
      btn.classList.remove('active');
    } else {
      document.querySelectorAll('.sev-btn').forEach(b => b.classList.remove('active'));
      activeSeverity = sev;
      btn.classList.add('active');
    }
  }

  loadImages();
</script>
</body>
</html>
